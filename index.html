<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WAITING</title>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>

<body>
<h3>Teachable Machine</h3>
<img id="img" width="250">

<script>
let model;

// SEND RESULT BACK
function sendResult(msg) {
    if (window.AppInventor) {
        AppInventor.setWebViewString(msg);
    }
    document.title = msg;
}

// LOAD MODEL
async function loadModel() {
    model = await tmImage.load(
        "https://pepalakrotiriou.github.io/potatocare/model/model.json",
        "https://pepalakrotiriou.github.io/potatocare/model/metadata.json"
    );
    sendResult("MODEL LOADED");
}

// RECEIVE BASE64 FROM APP INVENTOR
async function receiveFromAppInventor() {
    if (!window.AppInventor) return;

    const base64 = AppInventor.getWebViewString();
    const img = document.getElementById("img");

    img.src = "data:image/jpeg;base64," + base64;

    img.onload = async () => {
        const preds = await model.predict(img);

        let best = preds.reduce((a,b)=>a.probability>b.probability?a:b);
        sendResult(best.className + " " + (best.probability*100).toFixed(1) + "%");
    };
}

window.addEventListener("DOMContentLoaded", loadModel);
</script>
</body>
</html>
