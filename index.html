<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WAITING</title>

<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<style>
body { font-family: Arial; text-align: center; }
img { width: 250px; margin-top: 20px; }
</style>
</head>

<body>

<h2>Teachable Machine â€“ App Inventor</h2>
<div id="status">Loading model...</div>
<img id="preview"/>

<script>
let model;

// ðŸ”¹ SEND MESSAGE BACK TO APP INVENTOR (100% reliable)
function sendToApp(msg) {
    console.log("SEND:", msg);
    document.title = "RESULT:" + msg;
}

// ðŸ”¹ LOAD MODEL
async function loadModel() {
    try {
        const modelURL = "https://pepalakrotiriou.github.io/potatocare/model/model.json";
        const metadataURL = "https://pepalakrotiriou.github.io/potatocare/model/metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        document.getElementById("status").innerText = "Model loaded";
        sendToApp("MODEL LOADED");

    } catch (e) {
        document.getElementById("status").innerText = "MODEL LOAD ERROR";
        sendToApp("ERROR: MODEL LOAD FAILED");
    }
}

// ðŸ”¹ RECEIVE IMAGE FROM APP INVENTOR
window.fromAppInventor = function(base64) {
    console.log("Image received from App Inventor");

    const img = document.getElementById("preview");
    img.src = "data:image/jpeg;base64," + base64;

    img.onload = () => predict(img);
};

// ðŸ”¹ RUN PREDICTION
async function predict(img) {
    if (!model) {
        sendToApp("ERROR: MODEL NOT READY");
        return;
    }

    try {
        const preds = await model.predict(img);

        let bestClass = "";
        let bestProb = 0;

        preds.forEach(p => {
            if (p.probability > bestProb) {
                bestProb = p.probability;
                bestClass = p.className;
            }
        });

        document.getElementById("status").innerText =
            bestClass + " " + (bestProb * 100).toFixed(1) + "%";

        sendToApp(bestClass + " " + (bestProb * 100).toFixed(1) + "%");

    } catch (e) {
        sendToApp("ERROR: PREDICTION FAILED");
    }
}

window.addEventListener("DOMContentLoaded", loadModel);
</script>

</body>
</html>
